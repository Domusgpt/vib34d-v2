<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIB34D Individual Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Orbitron', monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: 
                radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
        }
        
        /* EXACT COPY of portfolio card styling */
        .variation-card {
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            position: relative;
            overflow: visible;
            transform-style: preserve-3d;
            transform-origin: 50% 50%;
            will-change: transform;
            width: 400px; /* Larger for standalone viewing */
            /* CSS variables for mouse tracking */
            --mouse-x: 50%;
            --mouse-y: 50%;
            --bend-intensity: 0;
        }
        
        .variation-card:hover {
            border-color: #00ffff;
            box-shadow: 
                0 30px 60px rgba(0, 255, 255, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.2),
                0 0 40px rgba(255, 0, 255, 0.4);
            transform: 
                perspective(800px)
                rotateY(calc((var(--mouse-x) - 50) * 0.3deg * var(--bend-intensity)))
                rotateX(calc((var(--mouse-y) - 50) * 0.15deg * var(--bend-intensity)))
                translateZ(calc(var(--bend-intensity) * 30px))
                translateY(-10px);
            backdrop-filter: blur(20px);
            z-index: 10;
        }
        
        .variation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #00ffff, #ff64ff, #ff9600);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .variation-card:hover::before {
            opacity: 1;
        }
        
        .card-preview {
            width: 100%;
            height: 300px; /* Larger for standalone viewing */
            aspect-ratio: 1 / 1;
            border-radius: 12px;
            overflow: visible;
            margin-bottom: 15px;
            background: #111;
            position: relative;
            border: 1px solid rgba(0, 255, 255, 0.2);
            transform-style: preserve-3d;
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* EXACT MATCH to portfolio cards: Proper X/Y position-based tilting with smooth animation */
        .variation-card:hover .card-preview {
            /* Host card responds to mouse position with subtle counter-tilt */
            transform: 
                perspective(1000px)
                translateZ(30px)
                scale(1.05)
                rotateY(calc((var(--mouse-x) - 50) * -0.15deg))
                rotateX(calc((50 - var(--mouse-y)) * 0.1deg));
            box-shadow: 
                0 0 50px rgba(0, 255, 255, 0.6),
                0 0 100px rgba(255, 0, 255, 0.4),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.8);
            background: rgba(17, 17, 17, 0.7);
            backdrop-filter: blur(15px);
            filter: brightness(1.2) contrast(1.05) saturate(1.1);
            overflow: visible;
            transition: transform 0.1s ease-out;
        }
        
        /* Canvas visualization container inside preview - EXACT MATCH */
        .visualization-container {
            width: 100%;
            height: 100%;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }
        
        /* Holographic shimmer effect overlay - DIRECTIONAL BASED ON MOUSE */
        .card-preview::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                calc(45deg + (var(--mouse-x) - 50) * 0.5deg),
                transparent 30%,
                rgba(0, 255, 255, 0.1) 50%,
                rgba(255, 0, 255, 0.1) 52%,
                transparent 70%
            );
            transform: translateX(calc(-100% + (var(--mouse-x) - 50) * 0.5%)) rotate(calc(45deg + (var(--mouse-x) - 50) * 0.3deg));
            transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: none;
            opacity: 0;
        }
        
        .variation-card:hover .card-preview::after {
            transform: translateX(calc(100% - (var(--mouse-x) - 50) * 0.5%)) rotate(calc(45deg + (var(--mouse-x) - 50) * 0.3deg));
            opacity: 1;
        }
        
        .system-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .system-badge.faceted {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
            color: #00ffff;
        }
        
        .system-badge.holographic {
            background: rgba(255, 100, 255, 0.2);
            border: 1px solid #ff64ff;
            color: #ff64ff;
        }
        
        .system-badge.quantum {
            background: rgba(100, 255, 150, 0.2);
            border: 1px solid #64ff96;
            color: #64ff96;
        }
        
        .system-badge.polychora {
            background: rgba(255, 150, 0, 0.2);
            border: 1px solid #ff9600;
            color: #ff9600;
        }
        
        .card-info h3 {
            color: #00ffff;
            font-size: 1.2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .card-params {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .card-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .card-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .card-btn:hover {
            background: rgba(0, 255, 255, 0.4);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        .card-btn.primary {
            background: rgba(255, 150, 0, 0.3);
            border-color: #ff9600;
            color: #ff9600;
        }
        
        .card-btn.primary:hover {
            background: rgba(255, 150, 0, 0.5);
            box-shadow: 0 0 15px rgba(255, 150, 0, 0.5);
        }
        
        /* Navigation buttons */
        .nav-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .nav-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .nav-btn:hover {
            background: rgba(0, 255, 255, 0.4);
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.5);
        }
        
        /* Perspective container for entire viewer */
        body {
            perspective: 2000px;
            perspective-origin: center center;
        }
    </style>
</head>
<body>
    <div class="nav-controls">
        <a href="gallery.html" class="nav-btn">‚Üê Back to Portfolio</a>
        <a href="index.html" class="nav-btn">Open in Engine</a>
    </div>
    
    <div class="variation-card" id="viewerCard">
        <div class="system-badge" id="systemBadge">SYSTEM</div>
        
        <div class="card-preview" data-preview-container>
            <div class="visualization-container" id="visualizationContainer">
                <!-- Visualization will be loaded here -->
            </div>
        </div>
        
        <div class="card-info">
            <h3 id="cardTitle">Loading...</h3>
            <div class="card-params" id="cardParams">
                Loading parameters...
            </div>
        </div>
        
        <div class="card-controls">
            <button class="card-btn" onclick="randomizeVisualization()">üé≤ Randomize</button>
            <button class="card-btn primary" onclick="loadIntoEngine()">üéõÔ∏è Load Engine</button>
            <button class="card-btn" onclick="generateTradingCard()">üé¥ Trading Card</button>
        </div>
    </div>

    <script type="module">
        // Parse URL parameters
        function parseURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            
            urlParams.forEach((value, key) => {
                if (key === 'name' || key === 'id') {
                    params[key] = value;
                } else {
                    params[key] = parseFloat(value) || value;
                }
            });
            
            return params;
        }
        
        // Initialize viewer
        async function initializeViewer() {
            const params = parseURLParameters();
            console.log('üé¨ VIB34D Individual Viewer - Loading parameters:', params);
            
            // Update UI with parameter info
            updateCardInfo(params);
            
            // Load the visualization engine for the specified system
            await loadVisualization(params);
            
            // Initialize mouse tracking effects
            initializeHolographicCardEffects();
            
            console.log('‚úÖ Individual viewer initialized');
        }
        
        function updateCardInfo(params) {
            const systemInfo = {
                faceted: { color: '#00ffff', name: 'FACETED' },
                holographic: { color: '#ff64ff', name: 'HOLOGRAPHIC' },
                quantum: { color: '#64ff96', name: 'QUANTUM' },
                polychora: { color: '#ff9600', name: 'POLYCHORA' }
            };
            
            const system = params.system || 'faceted';
            const sysInfo = systemInfo[system] || systemInfo.faceted;
            const name = params.name || 'VIB34D Variation';
            const globalId = params.id || '???';
            
            // Update system badge
            const badge = document.getElementById('systemBadge');
            badge.textContent = sysInfo.name;
            badge.className = `system-badge ${system}`;
            
            // Update title
            document.getElementById('cardTitle').textContent = `${name} #${globalId}`;
            
            // Update parameters display
            const paramsText = [
                `System: ${sysInfo.name}`,
                `Geometry: ${getGeometryName(params)}`,
                `Hue: ${Math.round(params.hue || 0)}¬∞`,
                `Grid Density: ${params.gridDensity || 15}`,
                `Morph Factor: ${(params.morphFactor || 1.0).toFixed(1)}`,
                `Speed: ${(params.speed || 1.0).toFixed(1)}x`
            ].join('<br>');
            
            document.getElementById('cardParams').innerHTML = paramsText;
            
            // Update page title
            document.title = `VIB34D ${sysInfo.name} - ${name}`;
        }
        
        function getGeometryName(params) {
            const geometryNames = ['TETRAHEDRON', 'HYPERCUBE', 'SPHERE', 'TORUS', 'KLEIN BOTTLE', 'FRACTAL', 'WAVE', 'CRYSTAL'];
            const polytopeNames = ['5-CELL', 'TESSERACT', '16-CELL', '24-CELL', '600-CELL', '120-CELL'];
            
            if (params.polytope !== undefined) {
                return polytopeNames[params.polytope] || 'POLYTOPE';
            }
            
            const geomType = params.geometryType !== undefined ? params.geometryType : params.geometry;
            return geometryNames[geomType] || 'GEOMETRY';
        }
        
        async function loadVisualization(params) {
            const container = document.getElementById('visualizationContainer');
            const system = params.system || 'faceted';
            
            // Create iframe with the same system and parameters, but in hideui mode
            const iframe = document.createElement('iframe');
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 12px;
                background: #000;
                transform-origin: center center;
            `;
            
            // Build parameter string
            const paramString = Object.entries(params)
                .filter(([key]) => !['name', 'id'].includes(key))
                .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
                .join('&');
            
            iframe.src = `index.html?system=${system}&hideui=true&${paramString}`;
            console.log(`üéØ Loading visualization: ${iframe.src}`);
            
            container.appendChild(iframe);
        }
        
        // EXACT COPY from gallery.html - Mouse tracking for individual viewer
        function initializeHolographicCardEffects() {
            console.log('üåü Initializing individual viewer holographic effects...');
            
            const card = document.getElementById('viewerCard');
            if (!card) return;
            
            let isHovering = false;
            
            // Mouse enter - start holographic effect
            card.addEventListener('mouseenter', (e) => {
                isHovering = true;
                card.style.setProperty('--bend-intensity', '0.8');
                console.log('üåå Viewer card holographic effect activated');
            });
            
            // Mouse leave - end holographic effect
            card.addEventListener('mouseleave', (e) => {
                isHovering = false;
                card.style.setProperty('--bend-intensity', '0');
                card.style.setProperty('--mouse-x', '50%');
                card.style.setProperty('--mouse-y', '50%');
                console.log('üåå Viewer card holographic effect deactivated');
            });
            
            // Mouse move - track position for card bending
            card.addEventListener('mousemove', (e) => {
                if (!isHovering) return;
                
                const rect = card.getBoundingClientRect();
                const cardX = ((e.clientX - rect.left) / rect.width) * 100;
                const cardY = ((e.clientY - rect.top) / rect.height) * 100;
                
                // Calculate distance from center for bend intensity
                const centerX = 50;
                const centerY = 50;
                const distanceFromCenter = Math.sqrt(
                    Math.pow(cardX - centerX, 2) + Math.pow(cardY - centerY, 2)
                );
                
                // Dynamic bend intensity based on mouse position
                const bendIntensity = Math.min(1, (distanceFromCenter / 70) + 0.3);
                
                // Update CSS variables for real-time transformation
                card.style.setProperty('--mouse-x', cardX);
                card.style.setProperty('--mouse-y', cardY);
                card.style.setProperty('--bend-intensity', bendIntensity);
            });
            
            console.log('‚úÖ Individual viewer holographic effects initialized');
        }
        
        // Action functions
        window.randomizeVisualization = function() {
            // Reload with randomized parameters
            window.location.reload();
        };
        
        window.loadIntoEngine = function() {
            // Load into main engine with current parameters
            const currentUrl = new URL(window.location.href);
            const engineUrl = new URL('index.html', window.location.origin);
            
            // Copy all parameters except name and id
            for (const [key, value] of currentUrl.searchParams) {
                if (!['name', 'id'].includes(key)) {
                    engineUrl.searchParams.set(key, value);
                }
            }
            
            window.location.href = engineUrl.toString();
        };
        
        window.generateTradingCard = async function() {
            try {
                // Import trading card generator
                const { TradingCardGenerator } = await import('./src/export/TradingCardGenerator.js');
                
                const params = parseURLParameters();
                const mockEngine = {
                    parameterManager: {
                        getAllParameters: () => params
                    }
                };
                
                window.currentSystem = params.system || 'faceted';
                
                const generator = new TradingCardGenerator(mockEngine);
                const result = await generator.generateTradingCard('classic');
                
                if (result.success) {
                    // Download the trading card
                    const blob = new Blob([result.html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    console.log('‚úÖ Trading card generated and downloaded');
                } else {
                    throw new Error(result.error || 'Generation failed');
                }
            } catch (error) {
                console.error('‚ùå Trading card generation failed:', error);
                alert('Trading card generation failed. Please try again.');
            }
        };
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeViewer();
        });
        
        console.log('üé¨ VIB34D Individual Viewer ready');
    </script>
</body>
</html>